<!DOCTYPE html>

<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>grafito.cr</title>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chivo&family=Chivo+Mono&display=swap" rel="stylesheet">
    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css" />
    <!-- Custom style-->
    <style>
        .b {color: #d8d8d8;background-color: #181818;font-weight: 600;tab-size: 8;}.lh {color: #7cafc2;background-color: #282828;}.t {color: #d8d8d8;}.e {color: #ab4642;}.c {color: #585858;}.cp {color: #a16946;}.cpf {color: #a1b56c;}.k {color: #ba8baf;}.kt {color: #ab4642;}.na {color: #7cafc2;}.nb {color: #ab4642;}.nbp {color: #ab4642;}.nc {color: #7cafc2;}.nc {color: #dc9656;}.nd {color: #dc9656;}.nf {color: #7cafc2;}.nn {color: #7cafc2;}.nt {color: #ba8baf;}.nv {color: #7cafc2;}.nvi {color: #ab4642;}.ln {color: #dc9656;}.o {color: #86c1b9;}.ow {color: #ba8baf;}.l {color: #a1b56c;}.ls {color: #a1b56c;}.lsi {color: #a16946;}.lsr {color: #86c1b9;}.lss {color: #dc9656;}
    </style>

<style>
/* These are just a tiny fraction of the pico color variables,
   will add more as I know what they do and which semantic
   value from base16 may make sense */

/* Theme: Apathy */
/* Author: Jannik Siebert (https://github.com/janniks) */

:root {
    --pico-background-color: #031a16; /* Default backround */
    --pico-color: #81b5ac; /* Default foreground */
    --pico-text-selection-color: #184e45; /* Selection background */
    --pico-primary: #96883e; /* Headings */
    --pico-primary-underline: var(--pico-primary);
    --pico-primary-background: #184e45;
    --pico-primary-hover: #3e7996; /* Link URL */
    --pico-primary-hover-underline: var(--pico-primary-hover);
    --pico-h1-color: var(--pico-primary); /* Default foreground */
    --pico-h2-color: var(--pico-primary); /* Default foreground */
    --pico-h3-color: var(--pico-primary); /* Default foreground */
    --pico-h4-color: var(--pico-primary); /* Default foreground */
    --pico-h5-color: var(--pico-primary); /* Default foreground */
    --pico-h6-color: var(--pico-primary); /* Default foreground */
}
</style>


<style>
    html * {
        font-family: Chivo, sans-serif;
        font-variant-ligatures: none;
        font-weight: 300;
        overflow: visible !important;
    }

    html {
        background: linear-gradient(to right, var(--pico-background-color) 50%, #0b342d 50%);
    }

    body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    footer {
        text-align: center;
        border-top: solid 1px #5f9c92;
        background-color: #031a16;
        margin-top: auto;
    }
    code {
        font-family: 'Chivo Mono', monospace !important;
        padding: .15rem;
        background-color: #0b342d !important;
    }

    code>span {
        font-family: 'Chivo Mono', monospace !important;
    }

    div.doc>pre>code  {
        background-color: #184e45;
        padding: 1em !important;
        font-family: 'Chivo Mono', monospace !important;
    }

    span.anchor {
        position: relative;
    }

    a.anchor {
        position: absolute;
        text-decoration: none;
        left: -1.2em;
        opacity: 0;
        -webkit-transition: opacity 0.2s linear;

            {
            # font-size: 150%;
            #
        }
    }

    div.doc:hover .anchor {
        opacity: 1;
    }

    @media (width < 768px) {
        html {
            background: var(--pico-background-color);
        }

        pre.code>code {
            overflow-x: auto !important;
        }
    }
</style>


<style>
    aside {
        position: fixed;
        top: 0;
        right: -20em;
        bottom: 0;
        width: 20em;
        background: var(--pico-background-color);
        overflow-y: auto;
        z-index: 100;
        padding: 1em;
        transition: right .25s;
        opacity: 90%;
    }

    #show-sidebar,
    #close-sidebar {
        position: absolute;
        top: 0em;
        right: 0em;
        padding: .5em;
        color: var(--pico-color-slate-100);
        text-decoration: none;
        background-color: var(--pico-color-slate-500);
        border-radius: 0 0 0 .5em;
        opacity: 75%;
        cursor: pointer;
    }

    #show-sidebar {
        position: fixed;
    }
</style>

</head>

<body>

<a id="show-sidebar" class="secondary" onclick="document.getElementById('sidebar').style.right='0em'">⬅
</a>
<aside id="sidebar">
    <a id="close-sidebar" class="secondary" onclick="document.getElementById('sidebar').style.right='-20em'">✖</a>
    <header>
        <h2>Documents</h2>
    </header>
    <nav>
        <ul>

            <li>

                <a href="../shard.yml.html"><span>shard.yml</span></a>

            </li>

            <li>

                <a href="fake_journal_data.cr.html"><span>src/fake_journal_data.cr</span></a>

            </li>

            <li>

                <span>src/grafito.cr</span>

            </li>

            <li>

                <a href="grafito_helpers.cr.html"><span>src/grafito_helpers.cr</span></a>

            </li>

            <li>

                <a href="journalctl.cr.html"><span>src/journalctl.cr</span></a>

            </li>

            <li>

                <a href="main.cr.html"><span>src/main.cr</span></a>

            </li>

            <li>

                <a href="timeline.cr.html"><span>src/timeline.cr</span></a>

            </li>

        </ul>
    </nav>
</aside>

    <main class="container">

</div>

<div id="section-1" class="grid">
    <div class="doc" id="section-1">
        <span class="anchor">
            <a href="#section-1" class="anchor">↦</a>
        </span>
        <h1>The Grafito Module</h1>
<p>This module defines the API for the grafito backend.</p>
<p>Since Grafito is not a very complicated application, the backend is just a few endpoints
exposing enough functionality to let you access log information. Because it's all
read only, they all use the <code>GET</code> method.</p>
<p>Some of them have perhaps too many arguments because they have grown following the UI
and could use some refactoring.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">./grafito_helpers</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">./journalctl</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">./timeline</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">baked_file_system</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">json</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">kemal</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="nk">require</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">mime</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">
</span><span class="nk">module</span><span class="t"> </span><span class="nc">Grafito</span><span class="t">
</span><span class="t">  </span><span class="nk">extend</span><span class="t"> </span><span class="nk">self</span></code></pre>
    </div>
</div>

<div id="section-2" class="grid">
    <div class="doc" id="section-2">
        <span class="anchor">
            <a href="#section-2" class="anchor">↦</a>
        </span>
        <p>Setup a logger for this module.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="nc">Log</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">::</span><span class="nc">Log</span><span class="t">.</span><span class="nk">for</span><span class="t">(</span><span class="nk">self</span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-3" class="grid">
    <div class="doc" id="section-3">
        <span class="anchor">
            <a href="#section-3" class="anchor">↦</a>
        </span>
        <p>Obtain the version number automatically at compile time from <a href="../shard.yml.html">shard.yml</a></p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="nc">VERSION</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="o">{{</span><span class="t"> </span><span class="ls">`</span><span class="ls">shards version </span><span class="lsi">#{</span><span class="t">__DIR__</span><span class="t"></span><span class="lsi">}</span><span class="ls">/../</span><span class="ls">`</span><span class="ls"></span><span class="t">.</span><span class="t">chomp</span><span class="t">.</span><span class="t">stringify</span><span class="t"> </span><span class="t">}</span><span class="t">}</span><span class="t"> </span><span class="c"># Adjusted path for shards version</span></code></pre>
    </div>
</div>

<div id="section-4" class="grid">
    <div class="doc" id="section-4">
        <span class="anchor">
            <a href="#section-4" class="anchor">↦</a>
        </span>
        <h2>The Assets class</h2>
<p>Bake all files from the src/assets directory into the binary.
The keys in the baked FS will be like &quot;/index.html&quot; for &quot;assets/index.html&quot;, etc.</p>
<p>This is important because it's what allows distributing Grafito as a single binary
without the need to ship a bunch of files alongside it.</p>
<p>All the things that are needed to function are baked-in:</p>
<ul>
<li>pico.css</li>
<li>htmx</li>
<li>index.html</li>
<li>style.css</li>
</ul>
<p>We are not embedding fonts and icons because they are not strictly
needed for Grafito to run, so if you run it without Internet access
it will work fine but fonts will look different and icons may be missing.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="nk">class</span><span class="t"> </span><span class="nc">Assets</span><span class="t">
</span><span class="t">    </span><span class="nk">extend</span><span class="t"> </span><span class="nc">BakedFileSystem</span><span class="t">
</span><span class="t">    </span><span class="t">bake_folder</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">./assets</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-5" class="grid">
    <div class="doc" id="section-5">
        <span class="anchor">
            <a href="#section-5" class="anchor">↦</a>
        </span>
        <p>One special endpoint is <code>/</code> because it serves the only page in the app.
We are serving a minified version which is source-mapped to the &quot;real&quot;
one <a href="">assets/index.html</a> sadly there is no literate version of it yet
because <a href="https://crycco.ralsina.me">Crycco</a> the tool I wrote and am
using has no support for HTML source files (yet)</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="t">serve_file</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">index.min.html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-6" class="grid">
    <div class="doc" id="section-6">
        <span class="anchor">
            <a href="#section-6" class="anchor">↦</a>
        </span>
        <p>This endpoint is just a wrapper to <code>serve_file</code> which sends the user
files from the baked assets.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/:file</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="t">filename</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">url</span><span class="t">[</span><span class="ls">&quot;</span><span class="ls">file</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">]</span><span class="t">
</span><span class="t">    </span><span class="t">serve_file</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="t">filename</span><span class="t">)</span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-7" class="grid">
    <div class="doc" id="section-7">
        <span class="anchor">
            <a href="#section-7" class="anchor">↦</a>
        </span>
        <p>Serves a file from the baked assets.
<code>requested_filename</code> is the name of the file as requested by the client (e.g., <code>style.css</code>).</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="nk">private</span><span class="t"> </span><span class="nk">def</span><span class="t"> </span><span class="nv">serve_file</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="t">requested_filename</span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-8" class="grid">
    <div class="doc" id="section-8">
        <span class="anchor">
            <a href="#section-8" class="anchor">↦</a>
        </span>
        <p>Files are stored as /style.css so fix the path and get the file contents.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">baked_path</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/</span><span class="lsi">#{</span><span class="t">requested_filename</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="t">file_content</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">Assets</span><span class="t">.</span><span class="t">get</span><span class="t">(</span><span class="t">baked_path</span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-9" class="grid">
    <div class="doc" id="section-9">
        <span class="anchor">
            <a href="#section-9" class="anchor">↦</a>
        </span>
        <p>We have to guess the content type based on the file extension.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">MIME</span><span class="t">.</span><span class="t">from_extension</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">.</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="o">+</span><span class="t"> </span><span class="t">requested_filename</span><span class="t">.</span><span class="t">split</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">.</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">.</span><span class="t">last</span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">content_type</span></code></pre>
    </div>
</div>

<div id="section-10" class="grid">
    <div class="doc" id="section-10">
        <span class="anchor">
            <a href="#section-10" class="anchor">↦</a>
        </span>
        <p>Set a reasonable cache lifetime</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">headers</span><span class="t">.</span><span class="t">add</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">Cache-Control</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">max-age=604800</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t"> </span><span class="c"># Cache for 1 week</span></code></pre>
    </div>
</div>

<div id="section-11" class="grid">
    <div class="doc" id="section-11">
        <span class="anchor">
            <a href="#section-11" class="anchor">↦</a>
        </span>
        <p>And send the data on its way.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="t">file_content</span><span class="t">.</span><span class="t">gets_to_end</span><span class="t">
</span><span class="t">  </span><span class="nk">rescue</span><span class="t"> </span><span class="nc">KeyError</span></code></pre>
    </div>
</div>

<div id="section-12" class="grid">
    <div class="doc" id="section-12">
        <span class="anchor">
            <a href="#section-12" class="anchor">↦</a>
        </span>
        <p>If it's not baked in, give a 404. Grafito will <em>NOT</em> return any files from disk.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">status_code</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ln">404</span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">File not found: </span><span class="lsi">#{</span><span class="nc">HTML</span><span class="t">.</span><span class="t">escape</span><span class="t">(</span><span class="t">requested_filename</span><span class="t">)</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-13" class="grid">
    <div class="doc" id="section-13">
        <span class="anchor">
            <a href="#section-13" class="anchor">↦</a>
        </span>
        <h2>The <code>/logs</code> endpoint</h2>
<p>Exposes the Journalctl wrapper via a REST API.
Example usage:</p>
<pre class="b" ><code class="b"><span class="t">GET /logs?unit=sshd.service&amp;tag=sshd</span><span class="t">
</span><span class="t"></span><span class="t">GET /logs?unit=nginx.service&amp;since=-1h</span></code></pre><p>In general all the parameters are derived from the journalctl CLI</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/logs</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Received /logs request with query params: </span><span class="lsi">#{</span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span></code></pre>
    </div>
</div>

<div id="section-14" class="grid">
    <div class="doc" id="section-14">
        <span class="anchor">
            <a href="#section-14" class="anchor">↦</a>
        </span>
        <p>A time definition. For example: <code>-1w</code> means &quot;since 1 week ago&quot;</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">since</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">since</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-15" class="grid">
    <div class="doc" id="section-15">
        <span class="anchor">
            <a href="#section-15" class="anchor">↦</a>
        </span>
        <p>What systemd unit do we want to see logs for.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">unit</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">unit</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-16" class="grid">
    <div class="doc" id="section-16">
        <span class="anchor">
            <a href="#section-16" class="anchor">↦</a>
        </span>
        <p>Filter logs by syslog tag</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">tag</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">tag</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-17" class="grid">
    <div class="doc" id="section-17">
        <span class="anchor">
            <a href="#section-17" class="anchor">↦</a>
        </span>
        <p>General search term from main input. Can be a regex and is matched to the message field.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">search_query</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">q</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-18" class="grid">
    <div class="doc" id="section-18">
        <span class="anchor">
            <a href="#section-18" class="anchor">↦</a>
        </span>
        <p>Filter logs by priority. All priorities &quot;less important&quot; than the requested one will be ignored.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">priority</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">priority</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-19" class="grid">
    <div class="doc" id="section-19">
        <span class="anchor">
            <a href="#section-19" class="anchor">↦</a>
        </span>
        <p>Filter logs by hostname (you can concentrate logs from multiple hosts!)</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">hostname</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">hostname</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-20" class="grid">
    <div class="doc" id="section-20">
        <span class="anchor">
            <a href="#section-20" class="anchor">↦</a>
        </span>
        <p>The UI allows for sorting by different fields</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">current_sort_by</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">sort_by</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">current_sort_order</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">sort_order</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-21" class="grid">
    <div class="doc" id="section-21">
        <span class="anchor">
            <a href="#section-21" class="anchor">↦</a>
        </span>
        <p>This endpoint can return in both HTML or text formats. HTML is useful because
the frontend is written using <a href="https://htmx.org">HTMX</a></p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">format_param</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">format</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-22" class="grid">
    <div class="doc" id="section-22">
        <span class="anchor">
            <a href="#section-22" class="anchor">↦</a>
        </span>
        <p>Determine column visibility from query parameters. The frontend allows
choosing which fields of the log entries are visible.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">show_timestamp_col</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">has_key?</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">col-visible-timestamp</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">show_hostname_col</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">has_key?</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">col-visible-hostname</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">show_unit_col</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">has_key?</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">col-visible-unit</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">show_priority_col</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">has_key?</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">col-visible-priority</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">show_message_col</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">has_key?</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">col-visible-message</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-23" class="grid">
    <div class="doc" id="section-23">
        <span class="anchor">
            <a href="#section-23" class="anchor">↦</a>
        </span>
        <p>FIXME: simplify</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">output_format</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">(</span><span class="t">format_param</span><span class="t">.</span><span class="t">presence</span><span class="t"> </span><span class="o">||</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">.</span><span class="t">downcase</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Querying Journalctl with: since=</span><span class="lsi">#{</span><span class="t">since</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, unit=</span><span class="lsi">#{</span><span class="t">unit</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, tag=</span><span class="lsi">#{</span><span class="t">tag</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, q=</span><span class="lsi">#{</span><span class="t">search_query</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, priority=</span><span class="lsi">#{</span><span class="t">priority</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, hostname=</span><span class="lsi">#{</span><span class="t">hostname</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, sort_by=</span><span class="lsi">#{</span><span class="t">current_sort_by</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, sort_order=</span><span class="lsi">#{</span><span class="t">current_sort_order</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, show_timestamp=</span><span class="lsi">#{</span><span class="t">show_timestamp_col</span><span class="t"></span><span class="lsi">}</span><span class="ls">, show_hostname=</span><span class="lsi">#{</span><span class="t">show_hostname_col</span><span class="t"></span><span class="lsi">}</span><span class="ls">, show_unit=</span><span class="lsi">#{</span><span class="t">show_unit_col</span><span class="t"></span><span class="lsi">}</span><span class="ls">, show_priority=</span><span class="lsi">#{</span><span class="t">show_priority_col</span><span class="t"></span><span class="lsi">}</span><span class="ls">, show_message=</span><span class="lsi">#{</span><span class="t">show_message_col</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span></code></pre>
    </div>
</div>

<div id="section-24" class="grid">
    <div class="doc" id="section-24">
        <span class="anchor">
            <a href="#section-24" class="anchor">↦</a>
        </span>
        <p>Now that we know exactly what logs we want, we send the query to the <code>journalctl</code> wrapper
defined in <a href="journalctl.cr.html">journalctl.cr</a>.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">logs</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">Journalctl</span><span class="t">.</span><span class="t">query</span><span class="t">(</span><span class="t">
</span><span class="t">      </span><span class="t">since</span><span class="t">:</span><span class="t"> </span><span class="t">since</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">unit</span><span class="t">:</span><span class="t"> </span><span class="t">unit</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">tag</span><span class="t">:</span><span class="t"> </span><span class="t">tag</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">query</span><span class="t">:</span><span class="t"> </span><span class="t">search_query</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">priority</span><span class="t">:</span><span class="t"> </span><span class="t">priority</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">hostname</span><span class="t">:</span><span class="t"> </span><span class="t">hostname</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">sort_by</span><span class="t">:</span><span class="t"> </span><span class="t">current_sort_by</span><span class="t">,</span><span class="t">
</span><span class="t">      </span><span class="t">sort_order</span><span class="t">:</span><span class="t"> </span><span class="t">current_sort_order</span><span class="t">
</span><span class="t">    </span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-25" class="grid">
    <div class="doc" id="section-25">
        <span class="anchor">
            <a href="#section-25" class="anchor">↦</a>
        </span>
        <p>If there are no logs matching our filters logs will be Nil.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="nk">if</span><span class="t"> </span><span class="t">logs</span></code></pre>
    </div>
</div>

<div id="section-26" class="grid">
    <div class="doc" id="section-26">
        <span class="anchor">
            <a href="#section-26" class="anchor">↦</a>
        </span>
        <p>But if we <em>do</em> have logs, we use one of two helpers to
create the actual responses.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="nk">if</span><span class="t"> </span><span class="t">output_format</span><span class="t"> </span><span class="o">==</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">        </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/plain</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">        </span><span class="t">output</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">_generate_text_log_output</span><span class="t">(</span><span class="t">logs</span><span class="t">)</span><span class="t">
</span><span class="t">      </span><span class="nk">else</span><span class="t"> </span><span class="c"># Default to HTML</span><span class="t">
</span><span class="t">        </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">        </span><span class="t">output</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">html_log_output</span><span class="t">(</span><span class="t">
</span><span class="t">          </span><span class="t">logs</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">current_sort_by</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">current_sort_order</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">search_query</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">show_timestamp</span><span class="t">:</span><span class="t"> </span><span class="t">show_timestamp_col</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">show_hostname</span><span class="t">:</span><span class="t"> </span><span class="t">show_hostname_col</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">show_unit</span><span class="t">:</span><span class="t"> </span><span class="t">show_unit_col</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">show_priority</span><span class="t">:</span><span class="t"> </span><span class="t">show_priority_col</span><span class="t">,</span><span class="t">
</span><span class="t">          </span><span class="t">show_message</span><span class="t">:</span><span class="t"> </span><span class="t">show_message_col</span><span class="t">
</span><span class="t">        </span><span class="t">)</span><span class="t">
</span><span class="t">      </span><span class="nk">end</span><span class="t">
</span><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="t">output</span><span class="t">
</span><span class="t">    </span><span class="nk">else</span></code></pre>
    </div>
</div>

<div id="section-27" class="grid">
    <div class="doc" id="section-27">
        <span class="anchor">
            <a href="#section-27" class="anchor">↦</a>
        </span>
        <p>If we failed to retrieve logs, we raise an error.
Probably 500 is the wrong one, and it should be a 404?</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">status_code</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ln">500</span><span class="t">
</span><span class="t">      </span><span class="nk">if</span><span class="t"> </span><span class="t">output_format</span><span class="t"> </span><span class="o">==</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">        </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/plain</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">      </span><span class="nk">else</span><span class="t"> </span><span class="c"># Default to HTML for errors too</span><span class="t">
</span><span class="t">        </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">      </span><span class="nk">end</span><span class="t">
</span><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Failed to retrieve logs.</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-28" class="grid">
    <div class="doc" id="section-28">
        <span class="anchor">
            <a href="#section-28" class="anchor">↦</a>
        </span>
        <h2>The <code>/services</code> endpoint</h2>
<p>Exposes the list of known service units. The frontend uses
it for autocomplete.
Example usage:</p>
<pre class="b" ><code class="b"><span class="t">GET /services</span></code></pre>
    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/services</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Received /services request</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span></code></pre>
    </div>
</div>

<div id="section-29" class="grid">
    <div class="doc" id="section-29">
        <span class="anchor">
            <a href="#section-29" class="anchor">↦</a>
        </span>
        <p>Here <code>known_service_units</code> is a wrapper around systemctl.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">service_units</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">Journalctl</span><span class="t">.</span><span class="t">known_service_units</span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">
</span><span class="t">    </span><span class="nk">if</span><span class="t"> </span><span class="t">service_units</span></code></pre>
    </div>
</div>

<div id="section-30" class="grid">
    <div class="doc" id="section-30">
        <span class="anchor">
            <a href="#section-30" class="anchor">↦</a>
        </span>
        <p>Build HTML options using html_builder</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t">(</span><span class="t">
</span><span class="t">        </span><span class="nc">HTML</span><span class="t">.</span><span class="t">build</span><span class="t"> </span><span class="nk">do</span><span class="t">
</span><span class="t">          </span><span class="t">service_units</span><span class="t">.</span><span class="t">each</span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">unit_name</span><span class="o">|</span><span class="t">
</span><span class="t">            </span><span class="t">option</span><span class="t">(</span><span class="t">value</span><span class="t">:</span><span class="t"> </span><span class="nc">HTML</span><span class="t">.</span><span class="t">escape</span><span class="t">(</span><span class="t">unit_name</span><span class="t">)</span><span class="t">)</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="t">}</span><span class="t">
</span><span class="t">          </span><span class="nk">end</span><span class="t">
</span><span class="t">        </span><span class="nk">end</span><span class="t">
</span><span class="t">      </span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="nk">else</span></code></pre>
    </div>
</div>

<div id="section-31" class="grid">
    <div class="doc" id="section-31">
        <span class="anchor">
            <a href="#section-31" class="anchor">↦</a>
        </span>
        <p>This should never happen unless something is broken in the system.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">status_code</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ln">500</span><span class="t">
</span><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">&lt;!-- Failed to retrieve service units --&gt;</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-32" class="grid">
    <div class="doc" id="section-32">
        <span class="anchor">
            <a href="#section-32" class="anchor">↦</a>
        </span>
        <h2>The <code>/command</code> endpoint</h2>
<p>Exposes the command that would be run by /logs with the given parameters.
Example usage:</p>
<pre class="b" ><code class="b"><span class="t">GET /command?since=-1h&amp;unit=nginx.service&amp;q=error`</span></code></pre><p>The frontend uss this to show what the <code>journalctl</code> command equivalent to the
configured filters would be.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/command</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Received /command request with query params: </span><span class="lsi">#{</span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span><span class="t">
</span><span class="t">
</span><span class="t">    </span><span class="t">since</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">since</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">unit</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">unit</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">tag</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">tag</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">search_query</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">q</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">priority</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">priority</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">hostname</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">hostname</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t"> </span><span class="c"># Also add to /command endpoint for consistency</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Building command with: since=</span><span class="lsi">#{</span><span class="t">since</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, unit=</span><span class="lsi">#{</span><span class="t">unit</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, tag=</span><span class="lsi">#{</span><span class="t">tag</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, q=</span><span class="lsi">#{</span><span class="t">search_query</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, priority=</span><span class="lsi">#{</span><span class="t">priority</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">, hostname=</span><span class="lsi">#{</span><span class="t">hostname</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span></code></pre>
    </div>
</div>

<div id="section-33" class="grid">
    <div class="doc" id="section-33">
        <span class="anchor">
            <a href="#section-33" class="anchor">↦</a>
        </span>
        <p>Here <code>build_query_command</code> is the same function used by <code>Journalctl.query</code> so the command line
should always be correct.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">command_array</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">Journalctl</span><span class="t">.</span><span class="t">build_query_command</span><span class="t">(</span><span class="t">since</span><span class="t">:</span><span class="t"> </span><span class="t">since</span><span class="t">,</span><span class="t"> </span><span class="t">unit</span><span class="t">:</span><span class="t"> </span><span class="t">unit</span><span class="t">,</span><span class="t"> </span><span class="t">tag</span><span class="t">:</span><span class="t"> </span><span class="t">tag</span><span class="t">,</span><span class="t"> </span><span class="t">query</span><span class="t">:</span><span class="t"> </span><span class="t">search_query</span><span class="t">,</span><span class="t"> </span><span class="t">priority</span><span class="t">:</span><span class="t"> </span><span class="t">priority</span><span class="t">,</span><span class="t"> </span><span class="t">hostname</span><span class="t">:</span><span class="t"> </span><span class="t">hostname</span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/plain</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">\&quot;</span><span class="lsi">#{</span><span class="t">command_array</span><span class="t">.</span><span class="t">join</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls"> </span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t"></span><span class="lsi">}</span><span class="ls">\&quot;</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-34" class="grid">
    <div class="doc" id="section-34">
        <span class="anchor">
            <a href="#section-34" class="anchor">↦</a>
        </span>
        <h2>The <code>/details</code> endpoint</h2>
<p>Exposes detailed information for a single log entry based on its cursor.
Example usage:</p>
<pre class="b" ><code class="b"><span class="t">GET /details?cursor=&lt;CURSOR_STRING&gt;`</span></code></pre><p>It will return a &quot;pretty JSON&quot; representation of the raw log entry
represented by the <code>cursor</code></p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/details</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Received /details request with query params: </span><span class="lsi">#{</span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span><span class="t">
</span><span class="t">    </span><span class="t">cursor</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">cursor</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span></code></pre>
    </div>
</div>

<div id="section-35" class="grid">
    <div class="doc" id="section-35">
        <span class="anchor">
            <a href="#section-35" class="anchor">↦</a>
        </span>
        <p>If there is no cursor, error out.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="nk">unless</span><span class="t"> </span><span class="t">cursor</span><span class="t">
</span><span class="t">      </span><span class="t">halt</span><span class="t"> </span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="t">status_code</span><span class="t">:</span><span class="t"> </span><span class="ln">400</span><span class="t">,</span><span class="t"> </span><span class="t">response</span><span class="t">:</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Missing cursor parameter. Cannot load details.</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span><span class="t">
</span><span class="t">
</span><span class="t">    </span><span class="nk">if</span><span class="t"> </span><span class="t">entry</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">Journalctl</span><span class="t">.</span><span class="t">get_entry_by_cursor</span><span class="t">(</span><span class="t">cursor</span><span class="t">)</span><span class="t">
</span><span class="t">      </span><span class="nc">HTML</span><span class="t">.</span><span class="t">build</span><span class="t"> </span><span class="nk">do</span></code></pre>
    </div>
</div>

<div id="section-36" class="grid">
    <div class="doc" id="section-36">
        <span class="anchor">
            <a href="#section-36" class="anchor">↦</a>
        </span>
        <p>We have no data for the entry, just show a message</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">        </span><span class="nk">if</span><span class="t"> </span><span class="t">entry</span><span class="t">.</span><span class="t">data</span><span class="t">.</span><span class="t">empty?</span><span class="t">
</span><span class="t">          </span><span class="t">p</span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="c"># ameba:disable Lint/DebugCalls</span><span class="t">
</span><span class="t">            </span><span class="t">text</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">No details available for this log entry.</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">          </span><span class="nk">end</span><span class="t">
</span><span class="t">        </span><span class="nk">else</span></code></pre>
    </div>
</div>

<div id="section-37" class="grid">
    <div class="doc" id="section-37">
        <span class="anchor">
            <a href="#section-37" class="anchor">↦</a>
        </span>
        <p>Create a pretty JSON version of the raw entry</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">          </span><span class="t">tag</span><span class="t">(</span><span class="ls">&quot;</span><span class="ls">pre</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t"> </span><span class="nk">do</span><span class="t">
</span><span class="t">            </span><span class="t">text</span><span class="t"> </span><span class="t">entry</span><span class="t">.</span><span class="t">to_pretty_json</span><span class="t">
</span><span class="t">          </span><span class="nk">end</span><span class="t">
</span><span class="t">        </span><span class="nk">end</span><span class="t">
</span><span class="t">      </span><span class="nk">end</span><span class="t">
</span><span class="t">    </span><span class="nk">else</span></code></pre>
    </div>
</div>

<div id="section-38" class="grid">
    <div class="doc" id="section-38">
        <span class="anchor">
            <a href="#section-38" class="anchor">↦</a>
        </span>
        <p>We didn't find the entry, so error out with a 404</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">status_code</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ln">404</span><span class="t">
</span><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Log entry not found for the given cursor.</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span><span class="t">
</span><span class="t">  </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-39" class="grid">
    <div class="doc" id="section-39">
        <span class="anchor">
            <a href="#section-39" class="anchor">↦</a>
        </span>
        <h2>The <code>/context</code> endpoint</h2>
<p>Exposes log entry context (entries before and after a given cursor).
Example usage:</p>
<pre class="b" ><code class="b"><span class="t">GET /context?cursor=&lt;CURSOR_STRING&gt;&amp;count=5`</span></code></pre><p>Works like <code>/query</code> but it will return some of the log entries
that are around the requested one for context.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">  </span><span class="t">get</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">/context</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="nk">do</span><span class="t"> </span><span class="o">|</span><span class="t">env</span><span class="o">|</span><span class="t">
</span><span class="t">    </span><span class="nc">Log</span><span class="t">.</span><span class="t">debug</span><span class="t"> </span><span class="t">{</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">Received /context request with query params: </span><span class="lsi">#{</span><span class="t">env</span><span class="t">.</span><span class="t">params</span><span class="t">.</span><span class="t">query</span><span class="t">.</span><span class="t">inspect</span><span class="t"></span><span class="lsi">}</span><span class="ls">&quot;</span><span class="ls"></span><span class="t"> </span><span class="t">}</span><span class="t">
</span><span class="t">    </span><span class="t">cursor</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">cursor</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">    </span><span class="t">count_str</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">optional_query_param</span><span class="t">(</span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">count</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">)</span><span class="t">
</span><span class="t">
</span><span class="t">    </span><span class="nk">unless</span><span class="t"> </span><span class="t">cursor</span><span class="t">
</span><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">      </span><span class="t">halt</span><span class="t"> </span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="t">status_code</span><span class="t">:</span><span class="t"> </span><span class="ln">400</span><span class="t">,</span><span class="t"> </span><span class="t">response</span><span class="t">:</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">&lt;p class=</span><span class="ls">\&quot;</span><span class="ls">error</span><span class="ls">\&quot;</span><span class="ls">&gt;Missing cursor parameter. Cannot load context.&lt;/p&gt;</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-40" class="grid">
    <div class="doc" id="section-40">
        <span class="anchor">
            <a href="#section-40" class="anchor">↦</a>
        </span>
        <p>Default to 5 if not provided or invalid</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">count</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">count_str</span><span class="t">.</span><span class="t">try</span><span class="t">(</span><span class="o">&amp;</span><span class="t">.</span><span class="t">to_i?</span><span class="t">)</span><span class="t"> </span><span class="o">||</span><span class="t"> </span><span class="ln">5</span><span class="t">
</span><span class="t">    </span><span class="nk">if</span><span class="t"> </span><span class="t">count</span><span class="t"> </span><span class="o">&lt;=</span><span class="t"> </span><span class="ln">0</span><span class="t">
</span><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">      </span><span class="t">halt</span><span class="t"> </span><span class="t">env</span><span class="t">,</span><span class="t"> </span><span class="t">status_code</span><span class="t">:</span><span class="t"> </span><span class="ln">400</span><span class="t">,</span><span class="t"> </span><span class="t">response</span><span class="t">:</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">&lt;p class=</span><span class="ls">\&quot;</span><span class="ls">error</span><span class="ls">\&quot;</span><span class="ls">&gt;Context count must be positive.&lt;/p&gt;</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span></code></pre>
    </div>
</div>

<div id="section-41" class="grid">
    <div class="doc" id="section-41">
        <span class="anchor">
            <a href="#section-41" class="anchor">↦</a>
        </span>
        <p>Get <code>count</code> entries before and after the cursor</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">    </span><span class="t">context_entries</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="nc">Journalctl</span><span class="t">.</span><span class="t">context</span><span class="t">(</span><span class="t">cursor</span><span class="t">,</span><span class="t"> </span><span class="t">count</span><span class="t">)</span><span class="t">
</span><span class="t">
</span><span class="t">    </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">content_type</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">text/html</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">if</span><span class="t"> </span><span class="t">context_entries</span></code></pre>
    </div>
</div>

<div id="section-42" class="grid">
    <div class="doc" id="section-42">
        <span class="anchor">
            <a href="#section-42" class="anchor">↦</a>
        </span>
        <p>Retain the specific title for the context view</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">title_html</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">&lt;h4&gt;Log Context (</span><span class="lsi">#{</span><span class="t">count</span><span class="t"></span><span class="lsi">}</span><span class="ls"> before &amp; after)&lt;/h4&gt;</span><span class="ls">&quot;</span><span class="ls"></span></code></pre>
    </div>
</div>

<div id="section-43" class="grid">
    <div class="doc" id="section-43">
        <span class="anchor">
            <a href="#section-43" class="anchor">↦</a>
        </span>
        <p>For context view, we generally want to see all columns, including Unit.
Sorting and search query are not directly applicable here, and we don´t
want the <code>chart</code>, a timeline of events, since they are all consecutive
in a short period.</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">generated_table_html</span><span class="t"> </span><span class="o">=</span><span class="t"> </span><span class="t">html_log_output</span><span class="t">(</span><span class="t">
</span><span class="t">        </span><span class="t">context_entries</span><span class="t">,</span><span class="t">          </span><span class="c"># The logs to display</span><span class="t">
</span><span class="t">        </span><span class="l">nil</span><span class="t">,</span><span class="t">                      </span><span class="c"># current_sort_by</span><span class="t">
</span><span class="t">        </span><span class="l">nil</span><span class="t">,</span><span class="t">                      </span><span class="c"># current_sort_order</span><span class="t">
</span><span class="t">        </span><span class="l">nil</span><span class="t">,</span><span class="t">                      </span><span class="c"># search_query</span><span class="t">
</span><span class="t">        </span><span class="t">chart</span><span class="t">:</span><span class="t"> </span><span class="l">false</span><span class="t">,</span><span class="t">             </span><span class="c"># No chart in context view</span><span class="t">
</span><span class="t">        </span><span class="t">highlight_cursor</span><span class="t">:</span><span class="t"> </span><span class="t">cursor</span><span class="t">,</span><span class="t"> </span><span class="c"># Highlight the original entry</span><span class="t">
</span><span class="t">        </span><span class="t">show_timestamp</span><span class="t">:</span><span class="t"> </span><span class="l">true</span><span class="t">,</span><span class="t">     </span><span class="c"># Always show all columns in context view</span><span class="t">
</span><span class="t">        </span><span class="t">show_hostname</span><span class="t">:</span><span class="t"> </span><span class="l">true</span><span class="t">,</span><span class="t">
</span><span class="t">        </span><span class="t">show_unit</span><span class="t">:</span><span class="t"> </span><span class="l">true</span><span class="t">,</span><span class="t">
</span><span class="t">        </span><span class="t">show_priority</span><span class="t">:</span><span class="t"> </span><span class="l">true</span><span class="t">,</span><span class="t">
</span><span class="t">        </span><span class="t">show_message</span><span class="t">:</span><span class="t"> </span><span class="l">true</span><span class="t">
</span><span class="t">      </span><span class="t">)</span></code></pre>
    </div>
</div>

<div id="section-44" class="grid">
    <div class="doc" id="section-44">
        <span class="anchor">
            <a href="#section-44" class="anchor">↦</a>
        </span>
        <p>Combine the custom title with the table generated by the helper</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="t">title_html</span><span class="t"> </span><span class="o">+</span><span class="t"> </span><span class="t">generated_table_html</span><span class="t">
</span><span class="t">    </span><span class="nk">else</span></code></pre>
    </div>
</div>

<div id="section-45" class="grid">
    <div class="doc" id="section-45">
        <span class="anchor">
            <a href="#section-45" class="anchor">↦</a>
        </span>
        <p>Journalctl.context might return nil if the original cursor was not found
or if the count was invalid (though we check count above).</p>

    </div>
    <div class="code">
        <pre class="b" ><code class="b"><span class="t">      </span><span class="t">env</span><span class="t">.</span><span class="t">response</span><span class="t">.</span><span class="t">print</span><span class="t"> </span><span class="ls">&quot;</span><span class="ls">&lt;p class=</span><span class="ls">\&quot;</span><span class="ls">error</span><span class="ls">\&quot;</span><span class="ls">&gt;Could not retrieve context for cursor: </span><span class="lsi">#{</span><span class="nc">HTML</span><span class="t">.</span><span class="t">escape</span><span class="t">(</span><span class="t">cursor</span><span class="t">)</span><span class="t"></span><span class="lsi">}</span><span class="ls">. The entry might not exist or an error occurred.&lt;/p&gt;</span><span class="ls">&quot;</span><span class="ls"></span><span class="t">
</span><span class="t">    </span><span class="nk">end</span><span class="t">
</span><span class="t">  </span><span class="nk">end</span><span class="t">
</span><span class="nk">end</span></code></pre>
    </div>
</div>


    </main>
    <footer>
        » Generated by <a href="https://crycco.ralsina.me">Crycco</a>
        » Layout
sidebyside

        » Theme: Apathy
        » Powered by <a href="https://picocss.com">PicoCSS</a> and <a href="https://www.omnibus-type.com/">Chivo Font
            Family</a>
    </footer>
</body>

</html>
